<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NeoHealth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f7f8; /* Lighter, slightly blue background */
            overflow: hidden;
        }

        /* Screen Styles */
        .screen {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            transition: opacity 0.7s ease-in-out;
            z-index: 10;
        }

        .intro-screen, .form-screen {
            align-items: center;
            justify-content: center;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        .intro-screen {
            background-image: url('images/background.jpg');
            background-size: cover;
            background-position: center;
            z-index: 50;
            position: relative; /* For layering */
        }

            .intro-screen h1 {
                font-family: 'Poppins', sans-serif;
                font-weight: 700;
                font-size: 4rem;
                color: #14b8a6; /* Teal-500 */
                text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
                animation: fadeIn 2s ease-in-out;
                text-align: center;
                padding: 0 1rem;
                position: relative; /* To ensure it's on top of the cloud */
                z-index: 2;
            }

        /* NEW: Cloud styles */
        .cloud-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60vw;
            max-width: 500px;
            z-index: 1;
            animation: fadeInCloud 2.5s ease-out;
            opacity: 0.8;
        }

        .form-screen {
            background-image: url('images/background.jpg');
            background-size: cover;
            background-position: center;
        }

        .form-container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
        }

        .dashboard-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            justify-content: flex-start;
        }

        .tab-active {
            background-color: #ccfbf1; /* Teal-100 */
            color: #0d9488; /* Teal-600 */
            font-weight: 600;
        }

        .tab-inactive {
            background-color: transparent;
            color: #4b5563; /* Gray-600 */
        }

        .food-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

            .food-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Calendar Styles */
        .calendar-day {
            transition: background-color 0.2s;
        }

            .calendar-day.has-data::after {
                content: '';
                display: block;
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: #f59e0b; /* Amber-500 */
                margin: 2px auto 0;
            }

        /* To-do List Styles */
        .todo-item.done .todo-text {
            text-decoration: line-through;
            color: #9ca3af; /* Gray-400 */
        }

        /* Chatbot Styles */
        .chat-bubble-user {
            background-color: #0d9488; /* Teal-600 */
            color: white;
            align-self: flex-end;
        }

        .chat-bubble-model {
            background-color: #e5e7eb; /* Gray-200 */
            color: #1f2937; /* Gray-800 */
            align-self: flex-start;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeInCloud {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }

            to {
                opacity: 0.8;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes shake {
            10%, 90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%, 80% {
                transform: translate3d(2px, 0, 0);
            }

            30%, 50%, 70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%, 60% {
                transform: translate3d(4px, 0, 0);
            }
        }
    </style>
</head>
<body>

    <!-- 1. Intro Screen (Splash Screen) -->
    <div id="introScreen" class="screen intro-screen">
        <div class="cloud-container">
            <svg viewBox="0 0 100 60" fill="white" xmlns="http://www.w3.org/2000/svg">
                <path d="M81.4,26.5C79.9,18.6,73,12.6,64.7,12.6c-4.9,0-9.3,2.1-12.3,5.4c-2.4-2-5.4-3.2-8.7-3.2c-7.3,0-13.2,5.9-13.2,13.2c0,0.5,0,1,0.1,1.5C19.3,30.1,11,38.5,11,49.1c0,6.3,5.1,11.4,11.4,11.4h56.1c6.3,0,11.4-5.1,11.4-11.4C89.9,41.9,86.4,33.3,81.4,26.5z" />
            </svg>
        </div>
        <h1>Welcome to NeoHealth</h1>
    </div>

    <!-- 2. Health Form Screen -->
    <div id="formScreen" class="screen form-screen hidden">
        <div class="form-container">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">First, let’s get you set up!</h2>
            <form id="healthForm" class="space-y-4">
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                    <input type="number" id="age" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required />
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="gender" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                    </select>
                </div>
                <div>
                    <label for="height" class="block text-sm font-medium text-gray-700">Height (cm)</label>
                    <input type="number" id="height" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required />
                </div>
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                    <input type="number" id="weight" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required />
                </div>
                <div>
                    <label for="activity" class="block text-sm font-medium text-gray-700">Activity Level</label>
                    <select id="activity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        <option value="sedentary">Sedentary</option>
                        <option value="light">Lightly active</option>
                        <option value="moderate">Moderately active</option>
                        <option value="active">Very active</option>
                    </select>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">Calculate & Start</button>
            </form>
        </div>
    </div>

    <!-- 3. Dashboard Screen -->
    <div id="dashboardScreen" class="screen dashboard-container hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white shadow-md flex flex-col flex-shrink-0">
            <div class="flex items-center justify-start p-4 border-b">
                <svg class="h-8 w-8 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                </svg>
                <h1 class="ml-3 text-2xl font-bold text-teal-700" style="font-family: 'Poppins', sans-serif;">NeoHealth</h1>
            </div>
            <nav class="flex-1 mt-6">
                <a href="#" id="tab-water" class="flex items-center py-3 px-4 m-2 rounded-lg transition-colors duration-200 tab-active">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2a9.5 9.5 0 00-9.5 9.5c0 4.34 3.5 9.1 8.5 11.35a1.5 1.5 0 002 0c5-2.25 8.5-7.01 8.5-11.35A9.5 9.5 0 0012 2z" /></svg>
                    <span class="ml-4">Water Intake</span>
                </a>
                <a href="#" id="tab-calories" class="flex items-center py-3 px-4 m-2 rounded-lg transition-colors duration-200 tab-inactive">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 2.25a2.25 2.25 0 00-2.25 2.25v13.5a2.25 2.25 0 002.25 2.25h1.5a2.25 2.25 0 002.25-2.25V4.5a2.25 2.25 0 00-2.25-2.25h-1.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-2.25 2.25m0 0l2.25 2.25M17.25 10.5h-10.5m10.5 0l-2.25-2.25m2.25 2.25l-2.25 2.25" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12.75l-2.25-2.25m0 0l2.25-2.25m-2.25 2.25h-10.5" /></svg>
                    <span class="ml-4">Calorie Counter</span>
                </a>
                <a href="#" id="tab-todos" class="flex items-center py-3 px-4 m-2 rounded-lg transition-colors duration-200 tab-inactive">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="ml-4">To-Do List</span>
                </a>
                <a href="#" id="tab-neocompanion" class="flex items-center py-3 px-4 m-2 rounded-lg transition-colors duration-200 tab-inactive">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 01-.923 1.785A5.969 5.969 0 006 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337z" /></svg>
                    <span class="ml-4">NeoCompanion</span>
                </a>
                <a href="#" id="tab-progress" class="flex items-center py-3 px-4 m-2 rounded-lg transition-colors duration-200 tab-inactive">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span class="ml-4">Monthly Progress</span>
                </a>
            </nav>
            <div class="p-4 border-t text-xs text-gray-500">
                <p>User ID:</p>
                <p id="user-id-display" class="break-words">Loading...</p>
            </div>
        </aside>

        <!-- Main Dashboard Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto bg-gray-50">
            <!-- Water Intake Panel -->
            <div id="content-water" class="h-full">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center justify-center">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Today's Water Goal</h2>
                        <div class="relative w-48 h-96"><svg viewBox="0 0 100 200" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect id="water-fill" x="10" y="190" width="80" height="0" fill="#38bdf8" rx="10" /><path d="M20,200 V50 Q20,20 50,20 Q80,20 80,50 V200 H20 Z M10,50 H90" stroke="#9ca3af" stroke-width="4" fill="none" /><path d="M40,20 V10 H60 V20" stroke="#9ca3af" stroke-width="4" fill="none" /></svg></div>
                        <div class="text-center mt-4">
                            <p class="text-3xl font-bold text-sky-500"><span id="water-current">0</span> ml</p>
                            <p class="text-gray-500">of <span id="water-goal">3000</span> ml</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                        <h3 class="text-xl font-bold text-gray-700 mb-6 text-center">Log Your Intake</h3>
                        <div id="water-log-options" class="grid grid-cols-2 gap-4 flex-1"></div>
                    </div>
                </div>
            </div>
            <!-- Calorie Counter Panel -->
            <div id="content-calories" class="hidden h-full">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                    <div class="lg:col-span-1 bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-700">Calorie Intake</h2>
                        <div id="fridge-container" class="relative w-64 h-96 my-4"><svg viewBox="0 0 120 200" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect id="fridge-fill" x="10" y="190" width="100" height="0" fill="#a7f3d0" rx="5" /><rect x="5" y="5" width="110" height="190" rx="10" stroke="#9ca3af" stroke-width="4" fill="none" /><line x1="5" y1="65" x2="115" y2="65" stroke="#9ca3af" stroke-width="4" /><rect x="85" y="15" width="10" height="30" rx="3" stroke="#9ca3af" stroke-width="2" fill="#e5e7eb" /></svg></div>
                        <div class="text-center">
                            <p class="text-3xl font-bold text-emerald-500"><span id="calorie-current">0</span> kcal</p>
                            <p class="text-gray-500">of <span id="calorie-goal">2000</span> kcal</p>
                            <p id="calorie-warning" class="text-amber-600 font-semibold mt-2 hidden">Daily limit reached!</p>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 overflow-y-auto">
                        <h3 class="text-xl font-bold text-gray-700 mb-6 text-center">What did you eat?</h3>
                        <div id="food-options" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </div>
            <!-- To-Do List Panel -->
            <div id="content-todos" class="hidden h-full">
                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col h-full">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Today's To-Do List</h2>
                    <form id="todo-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                        <input type="text" id="todo-input" placeholder="Add a new task..." class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required>
                        <div class="flex gap-2">
                            <input type="time" id="todo-start-time" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required>
                            <input type="time" id="todo-end-time" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required>
                        </div>
                        <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-500 hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Add</button>
                    </form>
                    <div id="todo-list" class="flex-1 overflow-y-auto space-y-3"></div>
                </div>
            </div>
            <!-- NeoCompanion Chat Panel -->
            <div id="content-neocompanion" class="hidden h-full">
                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col h-full">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Chat with NeoCompanion</h2>
                    <div id="chat-window" class="flex-1 overflow-y-auto space-y-4 p-4 bg-gray-100 rounded-lg mb-4 flex flex-col">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" required>
                        <button type="submit" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-500 hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Send</button>
                    </form>
                </div>
            </div>
            <!-- Monthly Progress Panel -->
            <div id="content-progress" class="hidden h-full">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
                    <div id="calendar-container" class="bg-white rounded-2xl shadow-lg p-4 flex flex-col"></div>
                    <div id="details-container" class="bg-white rounded-2xl shadow-lg p-6 overflow-y-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const introScreen = document.getElementById('introScreen');
        const formScreen = document.getElementById('formScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const healthForm = document.getElementById('healthForm');
        const todoForm = document.getElementById('todo-form');
        const chatForm = document.getElementById('chat-form');

        const tabs = {
            water: document.getElementById('tab-water'),
            calories: document.getElementById('tab-calories'),
            todos: document.getElementById('tab-todos'),
            neocompanion: document.getElementById('tab-neocompanion'),
            progress: document.getElementById('tab-progress'),
        };
        const contents = {
            water: document.getElementById('content-water'),
            calories: document.getElementById('content-calories'),
            todos: document.getElementById('content-todos'),
            neocompanion: document.getElementById('content-neocompanion'),
            progress: document.getElementById('content-progress'),
        };
        const water = {
            fill: document.getElementById('water-fill'),
            current: document.getElementById('water-current'),
            goal: document.getElementById('water-goal'),
            logOptions: document.getElementById('water-log-options'),
        };
        const calories = {
            fill: document.getElementById('fridge-fill'),
            container: document.getElementById('fridge-container'),
            warning: document.getElementById('calorie-warning'),
            current: document.getElementById('calorie-current'),
            goal: document.getElementById('calorie-goal'),
            foodOptions: document.getElementById('food-options'),
        };
        const todos = {
            list: document.getElementById('todo-list'),
            input: document.getElementById('todo-input'),
            startTime: document.getElementById('todo-start-time'),
            endTime: document.getElementById('todo-end-time'),
        };
        const neocompanion = {
            window: document.getElementById('chat-window'),
            input: document.getElementById('chat-input'),
        };
        const progress = {
            calendarContainer: document.getElementById('calendar-container'),
            detailsContainer: document.getElementById('details-container'),
        };
        const userIdDisplay = document.getElementById('user-id-display');

        // --- APP STATE & CONFIG ---
        let appState = {
            userId: null,
            currentWater: 0,
            waterGoal: 3000,
            waterGoalReachedToday: false,
            currentCalories: 0,
            calorieGoal: 2000,
            todos: [],
            chatHistory: [],
            lastLogDate: null,
            history: [],
            calendar: {
                year: new Date().getFullYear(),
                month: new Date().getMonth(),
                selectedDate: new Date().toISOString().split('T')[0],
            }
        };

        const waterLogAmounts = [
            { amount: 250, icon: '💧', label: 'Glass' },
            { amount: 500, icon: '🥤', label: 'Bottle' },
            { amount: 750, icon: '🫙', label: 'Large Bottle' },
            { amount: 1000, icon: '🚰', label: 'Jug' },
        ];

        const pakistaniFoods = [
            { name: 'Roti', calories: 120, img: 'images/roti.jpeg' },
            { name: 'Chicken Karahi', calories: 350, img: 'images/karahi.jpeg' },
            { name: 'Daal Chawal', calories: 400, img: 'images/daalchawal.jpeg' },
            { name: 'Biryani', calories: 450, img: 'images/biryani.jpeg' },
            { name: 'Seekh Kebab', calories: 180, img: 'images/kababs.jpeg' },
            { name: 'Samosa', calories: 150, img: 'images/samoosa.jpeg' },
            { name: 'Pakora', calories: 90, img: 'images/pakoray.jpeg' },
            { name: 'Haleem', calories: 380, img: 'images/haleem.jpeg' },
        ];

        // --- FIREBASE SETUP ---
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neohealth-app-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        appState.userId = user.uid;
                        userIdDisplay.textContent = user.uid.substring(0, 12) + '...';
                        await loadData();
                    } else {
                        setActiveScreen('form');
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                setActiveScreen('form');
            }
        }

        // --- DATA PERSISTENCE ---
        async function saveData() {
            if (!appState.userId || !db) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${appState.userId}/neoHealthData`);
                await setDoc(userDocRef, appState);
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }

        async function loadData() {
            if (!appState.userId || !db) {
                setActiveScreen('form');
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${appState.userId}/neoHealthData`);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                const today = new Date().toISOString().split('T')[0];

                appState.calorieGoal = data.calorieGoal || 2000;
                appState.waterGoal = data.waterGoal || 3000;
                appState.todos = data.todos || [];
                appState.chatHistory = data.chatHistory || [];

                if (data.lastLogDate !== today) {
                    appState.currentWater = 0;
                    appState.currentCalories = 0;
                    appState.waterGoalReachedToday = false;
                    appState.lastLogDate = today;
                } else {
                    appState.currentWater = data.currentWater || 0;
                    appState.currentCalories = data.currentCalories || 0;
                    appState.waterGoalReachedToday = data.waterGoalReachedToday || false;
                    appState.lastLogDate = data.lastLogDate;
                }
                appState.history = data.history || [];

                updateUI();
                setActiveScreen('dashboard');
            } else {
                updateUI();
                setActiveScreen('form');
            }
        }

        // --- SCREEN MANAGEMENT ---
        function setActiveScreen(screenName) {
            introScreen.classList.toggle('hidden', screenName !== 'intro');
            formScreen.classList.toggle('hidden', screenName !== 'form');
            dashboardScreen.classList.toggle('hidden', screenName !== 'dashboard');
        }

        // --- INITIAL FORM LOGIC ---
        healthForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const ageVal = parseInt(document.getElementById("age").value);
            const genderVal = document.getElementById("gender").value;
            const heightVal = parseFloat(document.getElementById("height").value);
            const weightVal = parseFloat(document.getElementById("weight").value);
            const activityVal = document.getElementById("activity").value;

            const waterML = weightVal * 35;
            appState.waterGoal = Math.round(waterML / 50) * 50;

            let bmr;
            if (genderVal === "male") {
                bmr = 10 * weightVal + 6.25 * heightVal - 5 * ageVal + 5;
            } else {
                bmr = 10 * weightVal + 6.25 * heightVal - 5 * ageVal - 161;
            }
            const activityFactor = { sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725 }[activityVal];
            appState.calorieGoal = Math.round(bmr * activityFactor);
            appState.lastLogDate = new Date().toISOString().split('T')[0];
            appState.waterGoalReachedToday = false;

            updateUI();
            saveData();
            setActiveScreen('dashboard');
        });

        // --- DASHBOARD UI & LOGIC ---
        function updateUI() {
            updateWaterUI();
            updateCaloriesUI();
            renderTodoList();
            renderChatHistory();
            renderCalendar();
            showDetailsForDate(appState.calendar.selectedDate);
        }

        function switchTab(targetTab) {
            Object.keys(tabs).forEach(key => {
                tabs[key].classList.replace(key === targetTab ? 'tab-inactive' : 'tab-active', key === targetTab ? 'tab-active' : 'tab-inactive');
                contents[key].classList.toggle('hidden', key !== targetTab);
            });
            if (targetTab === 'progress') updateUI();
            if (targetTab === 'water' && appState.waterGoalReachedToday) triggerConfetti();
            if (targetTab === 'todos') renderTodoList();
            if (targetTab === 'neocompanion') renderChatHistory();
        }

        function updateWaterUI() {
            water.current.textContent = appState.currentWater;
            water.goal.textContent = appState.waterGoal + ' ml';
            const percentage = Math.min(appState.currentWater / appState.waterGoal, 1);
            const fillHeight = percentage * 180;
            water.fill.setAttribute('y', 190 - fillHeight);
            water.fill.setAttribute('height', fillHeight);

            if (appState.currentWater >= appState.waterGoal && !appState.waterGoalReachedToday) {
                appState.waterGoalReachedToday = true;
                triggerConfetti();
                saveData();
            }
        }

        function triggerConfetti() {
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        }

        function renderWaterLogOptions() {
            water.logOptions.innerHTML = '';
            waterLogAmounts.forEach(({ amount, icon, label }) => {
                const button = document.createElement('button');
                button.className = "flex flex-col items-center justify-center p-4 bg-sky-50 rounded-lg text-sky-700 hover:bg-sky-100 transition-colors duration-200";
                button.innerHTML = `<span class="text-4xl">${icon}</span><span class="font-semibold mt-2">${amount} ml</span><span class="text-xs text-sky-500">${label}</span>`;
                button.onclick = () => logWater(amount);
                water.logOptions.appendChild(button);
            });
        }

        function updateCaloriesUI() {
            calories.current.textContent = appState.currentCalories;
            calories.goal.textContent = appState.calorieGoal + ' kcal';
            const percentage = Math.min(appState.currentCalories / appState.calorieGoal, 1.1);
            const fillHeight = (percentage > 1 ? 1 : percentage) * 180;

            calories.fill.setAttribute('y', 190 - fillHeight);
            calories.fill.setAttribute('height', fillHeight);

            if (appState.currentCalories > appState.calorieGoal) {
                calories.fill.setAttribute('fill', '#f97316'); // Orange-500 for warning
                calories.warning.classList.remove('hidden');
                if (!calories.container.classList.contains('shake')) {
                    calories.container.classList.add('shake');
                    setTimeout(() => calories.container.classList.remove('shake'), 500);
                }
            } else {
                calories.fill.setAttribute('fill', '#a7f3d0'); // Green color
                calories.warning.classList.add('hidden');
            }
        }

        function renderFoodOptions() {
            calories.foodOptions.innerHTML = '';
            pakistaniFoods.forEach(food => {
                const card = document.createElement('div');
                card.className = "food-card cursor-pointer bg-gray-50 rounded-lg p-2 flex flex-col items-center text-center";
                card.innerHTML = `<img src="${food.img}" alt="${food.name}" class="w-20 h-20 object-cover rounded-md mb-2" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/FFFFFF?text=Error';"><p class="font-semibold text-sm text-gray-800">${food.name}</p><p class="text-xs text-gray-500">${food.calories} kcal</p>`;
                card.onclick = () => logCalories(food.calories, food.name);
                calories.foodOptions.appendChild(card);
            });
        }

        // --- TO-DO LIST LOGIC ---
        todoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = todos.input.value.trim();
            const startTime = todos.startTime.value;
            const endTime = todos.endTime.value;
            if (text && startTime && endTime) {
                addTodo(text, startTime, endTime);
                todos.input.value = '';
                todos.startTime.value = '';
                todos.endTime.value = '';
            }
        });

        function addTodo(text, startTime, endTime) {
            const newTodo = { id: Date.now().toString(), text, startTime, endTime, done: false, date: new Date().toISOString().split('T')[0] };
            appState.todos.push(newTodo);
            renderTodoList();
            saveData();
        }

        function renderTodoList() {
            todos.list.innerHTML = '';
            const todayStr = new Date().toISOString().split('T')[0];
            const todaysTodos = appState.todos.filter(todo => todo.date === todayStr);

            if (todaysTodos.length === 0) {
                todos.list.innerHTML = `<p class="text-center text-gray-500 mt-8">No tasks for today. Add one!</p>`;
                return;
            }

            todaysTodos.forEach(todo => {
                const li = document.createElement('li');
                li.className = `todo-item flex items-center p-3 bg-gray-100 rounded-lg ${todo.done ? 'done' : ''}`;
                li.innerHTML = `
                        <button class="toggle-btn flex-shrink-0 h-6 w-6 rounded-full border-2 ${todo.done ? 'bg-teal-500 border-teal-500' : 'border-gray-300'} flex items-center justify-center">
                            ${todo.done ? '<svg class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>' : ''}
                        </button>
                        <span class="todo-text ml-4 flex-grow text-gray-700">${todo.text}</span>
                        <span class="ml-4 text-sm text-gray-500">${todo.startTime} - ${todo.endTime}</span>
                        <button class="delete-btn ml-4 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
                    `;
                li.querySelector('.toggle-btn').onclick = () => toggleTodoStatus(todo.id);
                li.querySelector('.delete-btn').onclick = () => deleteTodo(todo.id);
                todos.list.appendChild(li);
            });
        }

        function toggleTodoStatus(id) {
            const todo = appState.todos.find(t => t.id === id);
            if (todo) {
                todo.done = !todo.done;
                renderTodoList();
                saveData();
            }
        }

        function deleteTodo(id) {
            appState.todos = appState.todos.filter(t => t.id !== id);
            renderTodoList();
            saveData();
        }

        // --- NEOCOMPANION CHAT LOGIC ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = neocompanion.input.value.trim();
            if (!userInput) return;

            addMessageToHistory('user', userInput);
            neocompanion.input.value = '';
            neocompanion.input.disabled = true;

            try {
                const systemPrompt = "You are NeoCompanion, a friendly, supportive, and empathetic therapist. Your goal is to listen, provide comfort, and offer gentle guidance. You are not a medical professional and must not give medical advice. Remember details about the user to build rapport. You must decline any request that is not related to personal well-being, feelings, or mental health. Do not write essays, code, or answer general knowledge questions. If asked, gently redirect by saying something like, 'I'm here to listen to you. How are you feeling today?'";

                const historyForApi = [...appState.chatHistory];
                historyForApi.unshift({ role: "model", parts: [{ text: "I understand. I am NeoCompanion, and I'm here to listen and support you." }] });
                historyForApi.unshift({ role: "user", parts: [{ text: systemPrompt }] });


                const payload = { contents: historyForApi };
                const apiKey = "AIzaSyABOtYnqotuwmEaMln3f39BW9fXsIULDUk";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                let botResponse = "I'm having a little trouble connecting right now. Let's talk a bit later.";
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    botResponse = result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected API response:", result);
                    if (result.error && result.error.message) {
                        botResponse = `Sorry, I encountered an error: ${result.error.message}`;
                    }
                }
                addMessageToHistory('model', botResponse);

            } catch (error) {
                console.error("Error fetching bot response:", error);
                addMessageToHistory('model', "Sorry, I couldn't connect. Please try again.");
            } finally {
                neocompanion.input.disabled = false;
                neocompanion.input.focus();
            }
        });

        function addMessageToHistory(role, text) {
            appState.chatHistory.push({ role, parts: [{ text }] });
            renderChatHistory();
            saveData();
        }

        function renderChatHistory() {
            neocompanion.window.innerHTML = '';
            appState.chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `max-w-xs md:max-w-md p-3 rounded-lg ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}`;
                bubble.textContent = msg.parts[0].text;
                neocompanion.window.appendChild(bubble);
            });
            neocompanion.window.scrollTop = neocompanion.window.scrollHeight;
        }

        // --- CALENDAR & PROGRESS LOGIC ---
        function renderCalendar() {
            const { year, month } = appState.calendar;
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });

            const datesWithData = new Set([...appState.history.map(item => item.date), ...appState.todos.map(item => item.date)]);

            let html = `
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                        <h3 class="text-lg font-semibold">${monthName} ${year}</h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs text-gray-500">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div class="grid grid-cols-7 mt-2 text-center">
                `;

            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let classes = 'calendar-day h-10 flex items-center justify-center rounded-full cursor-pointer';
                if (datesWithData.has(dateStr)) classes += ' has-data';
                if (dateStr === todayStr) classes += ' bg-teal-500 text-white';
                if (dateStr === appState.calendar.selectedDate) classes += ' ring-2 ring-teal-500';

                html += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
            }

            html += `</div>`;
            progress.calendarContainer.innerHTML = html;

            document.getElementById('prev-month-btn').onclick = () => changeMonth(-1);
            document.getElementById('next-month-btn').onclick = () => changeMonth(1);
            progress.calendarContainer.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.onclick = () => {
                    const date = dayEl.getAttribute('data-date');
                    if (date) {
                        appState.calendar.selectedDate = date;
                        renderCalendar();
                        showDetailsForDate(date);
                    }
                };
            });
        }

        function changeMonth(direction) {
            appState.calendar.month += direction;
            if (appState.calendar.month < 0) {
                appState.calendar.month = 11;
                appState.calendar.year--;
            } else if (appState.calendar.month > 11) {
                appState.calendar.month = 0;
                appState.calendar.year++;
            }
            renderCalendar();
        }

        function showDetailsForDate(dateStr) {
            const intakeEntries = appState.history.filter(item => item.date === dateStr);
            const todoEntries = appState.todos.filter(item => item.date === dateStr);
            const formattedDate = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let html = `<h3 class="text-xl font-bold text-gray-800 mb-4">Details for ${formattedDate}</h3>`;

            if (intakeEntries.length === 0 && todoEntries.length === 0) {
                html += `<p class="text-gray-500">No activity logged on this day.</p>`;
            } else {
                if (intakeEntries.length > 0) {
                    html += '<h4 class="font-semibold text-teal-700 mb-2 mt-4">Intake Logs</h4><ul class="space-y-3">';
                    intakeEntries.forEach(item => {
                        const icon = item.type === 'water' ? '💧' : '🍴';
                        html += `<li class="flex items-start">${icon} <span class="ml-3">Logged <strong>${item.amount} ${item.type === 'water' ? 'ml' : 'kcal'}</strong> (${item.name})</span></li>`;
                    });
                    html += '</ul>';
                }
                if (todoEntries.length > 0) {
                    html += '<h4 class="font-semibold text-teal-700 mb-2 mt-4">Tasks for the Day</h4><ul class="space-y-3">';
                    todoEntries.forEach(item => {
                        const icon = item.done ? '✅' : '☑️';
                        html += `<li class="flex items-start ${item.done ? 'opacity-60' : ''}">${icon} <span class="ml-3">${item.text} <em class="text-gray-500">(${item.startTime} - ${item.endTime})</em></span></li>`;
                    });
                    html += '</ul>';
                }
            }
            progress.detailsContainer.innerHTML = html;
        }

        function logWater(amount) {
            appState.currentWater += amount;
            appState.history.push({ date: new Date().toISOString().split('T')[0], type: 'water', amount: amount, name: `${amount}ml intake` });
            updateWaterUI();
            saveData();
        }

        function logCalories(amount, name) {
            appState.currentCalories += amount;
            appState.history.push({ date: new Date().toISOString().split('T')[0], type: 'calories', amount: amount, name: name });
            updateCaloriesUI();
            saveData();
        }

        // --- INITIALIZATION ---
        function init() {
            setActiveScreen('intro');

            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(key);
                });
            });

            renderWaterLogOptions();
            renderFoodOptions();

            setTimeout(() => {
                initializeFirebase();
            }, 2500);
        }

        init();
    </script>
</body>
</html>
